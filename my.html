<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="canonical" href="https://borg.games/" />

    <link rel="shortcut icon" href="/favicon.svg" sizes="any" type="image/svg+xml" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#0d0d0d">
    <meta name="msapplication-TileColor" content="#101010">
    <meta name="theme-color" content="#000000">

    <title>Games on my PCs - Borg Games</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        button.action {
            font-size: larger;
            text-transform: uppercase;
            padding: 0.5vh 1vh;
        }

        a[href] {
            color: white;
        }
    </style>
</head>

<body style="text-align: center; background: #1e1e1e; color: #cedada;">
    <h1>Games on my PCs</h1>

    <div class="video-container">
        <video autoplay></video>
    </div>

    <div id="PCs">
    </div>

    <p style="display: inline-block;">
    <h3><a href="/about">About Borg Queen</a></h3>
    </p>

    <script src="https://alcdn.msauth.net/browser/2.35.0/js/msal-browser.min.js"
        integrity="sha384-PARf28kmic36Ve+O3DnUerRXFtOQ7ZDqRDGpLcbljly5/N39T2OV3kt3QsWOKeAX"
        crossorigin="anonymous"></script>
    <script type="module">
        import * as OneDrive from './js/onedrive.js';

        import { AudioPlayer } from './js/streaming-client/src/audio.js';
        import { Client } from './js/streaming-client/src/client.js';
        import { ClientAPI } from './js/client-api.js';
        import { getNetworkStatistics } from './js/connectivity-check.js';
        import { OneDriveSignal } from './js/drive-link.js';

        AudioPlayer.OPUS_WASM = '/js/streaming-client/src/wasm/opus.wasm';

        const clientApi = new ClientAPI();
        const pcList = document.getElementById('PCs');

        function runClient(pc, gameID, signalFactory, element, sessionId) {
            return new Promise(async (resolve) => {
                //set up client object with an event callback: gets connect, status, chat, and shutter events
                const client = new Client(clientApi, signalFactory, element, (event) => {
                    console.log('EVENT', event);

                    if (event.type === 'exit') {
                        document.removeEventListener('keydown', hotkeys, true);
                        resolve(event.code);
                    }
                }, async (name, channel) => {
                    return getNetworkStatistics(channel);
                });
                //set up useful hotkeys that call client methods: destroy can also be used to cancel pending connection
                const hotkeys = (event) => {
                    event.preventDefault();

                    if (event.code === 'Backquote' && event.ctrlKey && event.altKey) {
                        client.destroy(0);
                    } else if (event.code === 'KeyW' && event.ctrlKey && event.altKey) {
                        toggleFullscreen(client.element);
                    }
                };
                document.addEventListener('keydown', hotkeys, true);

                const cancel = { cancel: false };

                const connectionTimeout = setTimeout(() => {
                    cancel.cancel = true;
                    client.destroy(Client.StopCodes.CONNECTION_TIMEOUT);
                }, 1000 /*s*/ * 60 /*m*/ * 3);

                const serverOffer = JSON.parse(await OneDriveSignal.postAssignment(pc, gameID, sessionId, cancel));

                await client.connect(sessionId, serverOffer, {
                    encoder_bitrate: 12,
                    app_ss_endpoint: 'localhost',
                    app_ss_port: 7173,
                });

                clearTimeout(connectionTimeout);
            });
        }

        async function launch(pc, gameID) {
            const sessionId = crypto.randomUUID();
            const signalFactory = (onFatal) => {
                return new OneDriveSignal(pc, onFatal);
            };

            const container = document.querySelector('.video-container');
            const element = document.querySelector('video');

            pcList.style.display = 'none';
            container.style.display = 'block';

            const code = await runClient(pc, gameID, signalFactory, element, sessionId);

            pcList.style.display = '';
            container.style.display = '';

            element.src = '';
            element.load();

            if (code !== 0)
                alert(`Exit code: ${code}`);
        }

        async function getGames(pc, li) {
            const response = await OneDrive.makeRequest(`special/approot:/PCs/${pc}.games.json:/content`);
            const items = await response.json();
            for (const item of items) {
                const gameItem = document.createElement('div');
                const button = document.createElement('button');
                button.innerText = item.Title;
                button.onclick = () => {
                    launch(pc, item.ID);
                };
                gameItem.appendChild(button);
                li.appendChild(gameItem);
            }
        }

        async function getPCs() {
            const response = await OneDrive.makeRequest('special/approot:/PCs:/children');
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            const json = await response.json();
            const items = json.value;
            const listUI = document.getElementById('PCs');
            for (const item of items) {
                if (!item.hasOwnProperty('folder')) continue;
                const li = document.createElement('div');
                const title = document.createElement('h3');
                title.innerText = item.name;
                li.appendChild(title);

                await getGames(item.name, li);
                listUI.appendChild(li);
            }
        }

        async function main() {
            await OneDrive.login();

            await OneDrive.ensureBorgTag();

            await getPCs();
        }

        main();
    </script>
</body>

</html>