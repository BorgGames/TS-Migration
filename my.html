<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="canonical" href="https://borg.games/" />

    <link rel="shortcut icon" href="/favicon.svg" sizes="any" type="image/svg+xml" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#0d0d0d">
    <meta name="msapplication-TileColor" content="#101010">
    <meta name="theme-color" content="#000000">

    <title>Games on my PCs - Borg Games</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        a[href] {
            color: white;
        }
    </style>
</head>

<body style="text-align: center; background: #1e1e1e; color: #cedada;">
    <div class="video-container">
        <video autoplay></video>
    </div>

    <div id="launcher" style="text-align: initial;">
        <div id="no-pcs" style="display: none;">
            <h2>No PCs connected</h2>
        </div>
        <select id="game-list" style="display: none;"></select>
        <div id="game-details" style="display: none;">
            <h1 id="game-title"></h1>
            <div>
                <button id="launch-button" type="button">Play</button>
                <select id="game-pc"></select>
            </div>
            <div id="game-running"></div>
        </div>
    </div>

    <h3 style="display: inline-block;"><a href="/about">About Borg Queen</a></h3>

    <script src="https://alcdn.msauth.net/browser/2.35.0/js/msal-browser.min.js"
        integrity="sha384-PARf28kmic36Ve+O3DnUerRXFtOQ7ZDqRDGpLcbljly5/N39T2OV3kt3QsWOKeAX"
        crossorigin="anonymous"></script>
    <script type="module">
        import * as util from './js/streaming-client/src/util.js';
        import * as OneDrive from './js/onedrive.js';

        import { AudioPlayer } from './js/streaming-client/src/audio.js';
        import { Client } from './js/streaming-client/src/client.js';
        import { ClientAPI } from './js/client-api.js';
        import { OneDriveSignal } from './js/drive-link.js';
        import { OneDriveRunningGames } from './js/drive-gamefs.js';
        import { GameID } from './js/gid.js';
        import { Launcher } from './js/launcher.js';

        import * as My from "./js/my.js";

        AudioPlayer.OPUS_WASM = '/js/streaming-client/src/wasm/opus.wasm';

        const clientApi = new ClientAPI();
        const launcherUI = document.getElementById('launcher');
        const gameList = document.getElementById('game-list');

        function runClient(pc, signalFactory, element, sessionId, timeout) {
            return new Promise(async (resolve) => {
                //set up client object with an event callback: gets connect, status, chat, and shutter events
                const client = new Client(clientApi, signalFactory, element, (event) => {
                    console.log('EVENT', event);

                    if (event.type === 'exit') {
                        document.removeEventListener('keydown', hotkeys, true);
                        resolve(event.code);
                    }
                }, async (name, channel) => {
                    await My.waitForCommandRequest(channel);
                    channel.send(sessionId);
                    await My.waitForCommandRequest(channel);
                });
                //set up useful hotkeys that call client methods: destroy can also be used to cancel pending connection
                const hotkeys = (event) => {
                    event.preventDefault();

                    if (event.code === 'Backquote' && event.ctrlKey && event.altKey) {
                        client.destroy(0);
                    } else if (event.code === 'KeyW' && event.ctrlKey && event.altKey) {
                        util.toggleFullscreen(client.element);
                    }
                };
                document.addEventListener('keydown', hotkeys, true);

                try {
                    const offer = await OneDriveSignal.getServerOffer(pc, timeout);

                    await Promise.race([
                        timeout,
                        client.connect(offer.session, offer.sdp, {
                            encoder_bitrate: parseInt(localStorage.getItem('encoder_bitrate')) || 1,
                            app_ss_endpoint: 'localhost',
                            app_ss_port: 7173,
                        })]);
                } catch (e) {
                    console.error(e);
                    resolve(Client.StopCodes.CONNECTION_TIMEOUT);
                }
            });
        }

        async function launch(gameOffer, sessionId) {
            const signalFactory = (onFatal) => {
                return new OneDriveSignal(gameOffer.pc, onFatal);
            };

            const container = document.querySelector('.video-container');
            const element = document.querySelector('video');

            launcherUI.style.display = 'none';
            container.style.display = 'block';

            const timeout = util.timeout(1000 /*s*/ * 60 /*m*/ * 3);

            const exe = GameID.tryGetExe(gameOffer.Uri);
            try {
                const launch = !sessionId;
                if (!sessionId)
                    sessionId = crypto.randomUUID();
                const run = await Promise.all([
                    runClient(gameOffer.pc, signalFactory, element, exe + '\\' + sessionId, timeout),
                    launch
                        ? OneDriveRunningGames.launch(gameOffer.pc, exe, sessionId, timeout)
                        : OneDriveRunningGames.assertRunning(gameOffer.pc, exe, sessionId, timeout)
                ]);
                const code = run[0];

                if (code !== 0)
                    alert(`Exit code: ${code}`);
            } catch (e) {
                console.log(e);
                alert(e);
            } finally {
                launcherUI.style.display = '';
                container.style.display = '';

                element.src = '';
                element.load();

                Launcher.selectGame(gameOffer.Uri);
            }
        }

        async function reloadGameList() {
            gameList.innerHTML = '';
            gameList.size = 0;

            const response = await OneDrive.makeRequest('special/approot:/PCs:/children');
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            const json = await response.json();
            const items = json.value;
            for (const item of items) {
                if (!item.hasOwnProperty('folder')) continue;
                await My.getGames(item.name, gameList);
            }

            if (items.length === 0) {
                document.getElementById('no-pcs').style.display = 'block';
                gameList.style.display = 'none';
            } else {
                document.getElementById('no-pcs').style.display = 'none';
                gameList.style.display = 'block';
            }

            if (gameList.options.length === 0) {
                Launcher.selectGame(null);
            } else {
                Launcher.selectGame(gameList.options[0].value);
            }
        }

        async function main() {
            Launcher.launch = launch;
            Launcher.initialize(My.Games.games);

            await OneDrive.login();

            await OneDrive.ensureBorgTag();

            await reloadGameList();
        }

        main();
    </script>
</body>

</html>